{% extends "base.html" %}

{% block title %}Balance{% endblock %}

{% block footer %}

<script src="../js/chart.js"></script>
<script src="../js/dates.js"></script>
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.5.1/chart.min.js"></script>

<script>

  $(document).ready(function () {
    $(document).on('click', 'td[data-role=update]', function () {
      let id = ($(this).data('id'));
      let category = $('#' + id).children('td[data-target=category]').text();
      let amount = $('#' + id).children('td[data-target=amount]').text();
      let date = $('#' + id).children('td[data-target=date]').text();
      let paymentMethod = $('#' + id).children('td[data-target=paymentMethod]').text();
      let comment = $('#' + id).children('td[data-target=comment]').text();

      // alert(id + category + amount + date + paymentMethod + comment);
      $('#inputAmount').val(amount);
      $('#selectedDate').val(date);
      $('#category').val(category);
      $('#payment').val(paymentMethod);
      $('#comment').val(comment);
      $('#expenseId').val(id);
      $('#editExpenseModal').modal('toggle');

    });

    $('#modal-select').click(function (event) {
      event.preventDefault();

      let id = $('#expenseId').val();
      let amount = $('#inputAmount').val();
      let date = $('#selectedDate').val();
      let category = $('#category').val();
      let payment = $('#payment').val();
      let comment = $('#comment').val();

      $.ajax({
        url: '/expense/updateExpense',
        method: 'POST',
        data: { amount: amount, date: date, category: category, payment: payment, comment: comment, id: id },
        traditional: true,
        success: function (response) {
          console.log("See response: " + response);
          $('#' + id).children('td[data-target=amount]').text(amount);
          $('#' + id).children('td[data-target=date]').text(date);
          $('#' + id).children('td[data-target=category]').text(category);
          $('#' + id).children('td[data-target=paymentMethod]').text(payment);
          $('#' + id).children('td[data-target=comment]').text(comment);
          $('#editExpenseModal').modal('toggle');
        }
      });

    });

  });

</script>

<script>


</script>

{% endblock %}

{% block body %}


<nav id="mainNavbar" class="navbar navbar-light navbar-expand-xl pt-1 px-0">
  <a href="../mainmenu/index" class="navbar-brand"><i class="icon-money-1 d-none d-lg-inline"></i>PERSONAL
    BUDGET</a>
  <button class="navbar-toggler" data-toggle="collapse" data-target="#navLinks" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navLinks">
    <ul class="navbar-nav mt-3">
      <li class="nav-item">
        <a href="../mainmenu/index" class="nav-link"><i class="bi bi-house-fill inputGroup-sizing-lg mr-1"></i>Home</a>
      </li>
      <li class="nav-item">
        <a href="/logout" class="nav-link"><i class="bi bi-box-arrow-right inputGroup-sizing-lg mr-1"></i>Log out</a>
      </li>
    </ul>
  </div>

</nav>

<section class="container-fluid px-0 mx-0">

  <div class="balance-display mx-3 mb-5">
    <div class="row align-items-start justify-content-center mt-3 mt-lg-5">
      <div class="col-12 col-lg-6 balance text-center text-lg-right mt-4">Balance from period: </div>

      <div class="col-12 col-lg-6 balance display-date text-center text-lg-left mt-lg-4">
        {{ startDate }} - {{ endDate }}
      </div>
    </div>


    <div class="row align-items-start justify-content-center ">

      <div id="expenses" class="line-h col-md-6 order-1 order-md-1 px-0">

        <div class="row justify-content-center mx-0">

          <h2 class="header display-5 p-3 mt-1 mt-lg-5">Expenses</h2>

        </div>

        <div class="row justify-content-center mx-3 mb-1">
          <div class="col-sm-12 col-lg-8">

            <table id="expensesTable" class="table table-hover table-sm">
              <thead class="thead-dark">
                <tr class="text-center">
                  <th scope="col">Category</th>
                  <th scope="col">Amount</th>
                </tr>
              </thead>
              <tbody>
                {% for sumExpensesByCategory in sumExpensesByCategories %}
                <tr>
                  <td class="pl-3">{{ sumExpensesByCategory.expense_category_name }}</td>
                  <td class="text-center">{{ sumExpensesByCategory.sum_expenses }}</td>
                </tr>
                {% endfor %}

              </tbody>
            </table>



          </div>

        </div>
      </div>

      <div id="incomes" class="line-h col-md-6 order-2 order-md-2 px-0">
        <div class="row justify-content-center mx-0">

          <h2 class="header display-5 p-3 mt-1 mt-lg-5">Incomes</h2>

        </div>
        <div class="row justify-content-center mx-3 mb-1">
          <div class="col-sm-12 col-lg-8">
            <table id="incomesTable" class="table table-hover table-sm">
              <thead class="thead-dark ">
                <tr class="text-center">
                  <th scope="col">Category</th>
                  <th scope="col">Amount</th>
                </tr>
              </thead>
              <tbody>

                {% for sumIncomesByCategory in sumIncomesByCategories %}
                <tr>
                  <td data-target="all-category" class="pl-3">{{ sumIncomesByCategory.income_category_name }}</td>
                  <td data-target="sum" class="text-center">{{ sumIncomesByCategory.sum_incomes}}</td>
                </tr>
                {% endfor %}


              </tbody>
            </table>


          </div>
        </div>
      </div>
    </div>
    <div class="line-h row align-items-start justify-content-center">
      <h2 class="header display-5 p-3 mt-1 mt-lg-5">Individual expenses</h2>
    </div>

    <div class="row justify-content-center  mx-0 mb-1">
      <div class="col-sm-12 col-lg-10 ">
        <table class="table table-hover table-sm">
          <thead class="thead-dark">
            <tr class="text-center">
              <th scope="col">Category</th>
              <th scope="col">Amount</th>
              <th scope="col">Date</th>
              <th scope="col">Payment method</th>
              <th scope="col">Comment</th>
              <th scope="col" style="width: 5%"></th>
            </tr>
          </thead>
          <tbody>

            {% for individualExpense in individualExpenses %}
            <tr id="{{individualExpense.id}}">
              <td data-target="category" class="pl-3">{{ individualExpense.expense_category_name }}</td>
              <td data-target="amount" class="text-center">{{ individualExpense.amount }}</td>
              <td data-target="date" class="text-center">{{ individualExpense.date_of_expense }}</td>
              <td data-target="paymentMethod" class="text-center">{{ individualExpense.payment }}</td>
              <td data-target="comment" class="comment">{{ individualExpense.expense_comment }}</td>
              <td data-role="update" data-id="{{individualExpense.id}}"><i
                  class="justify-content-center input-group-append bi bi-pencil-square inputGroup-sizing-lg mt-2"></i>
              </td>
            </tr>
            {% endfor %}

          </tbody>
        </table>

        <!-- modal -->
        <div id="editExpenseModal" class="modal fade custom" tabindex="-1" role="dialog">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Edit expense</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <form action="" method="post" class="p-2 m-2">
                <div class="modal-body">
                  <div class="input-group mt-3">
                    <div class="input-group-prepend">
                      <span class="input-group-text" id="basic-addon1"><i
                          class="icon-money inputGroup-sizing-lg"></i></span>
                    </div>
                    <input type="number" name="amount" class="form-control form-control-lg" id="inputAmount" step="0.01"
                      placeholder="0.00" value="" aria-label="amount" aria-describedby="basic-addon1">
                  </div>

                  <span class="errors">{{ expense.errors.amount }}</span>

                  <div class="input-group mt-3">
                    <div class="input-group-prepend">
                      <span class="input-group-text" id="basic-addon2"><i
                          class="icon-calendar inputGroup-sizing-lg"></i></span>
                    </div>
                    <input type="date" name="date" class="form-control form-control-lg" id="selectedDate"
                      aria-label="date" aria-describedby="basic-addon2">
                  </div>

                  <span class="errors">{{ expense.errors.date }}</span>

                  <div class="input-group mt-3">
                    <div class="input-group-prepend">
                      <span class="input-group-text" id="basic-addon3"><i
                          class="icon-tags inputGroup-sizing-lg"></i></span>
                    </div>
                    <select id="category" class="category form-control form-control-lg" name="category"
                      aria-label="category" aria-describedby="basic-addon3">
                      <option value="" disabled="" selected="" hidden="">-- category--
                      </option>

                      {% for expenseCategory in expensesCategory %}
                      <option>{{ expenseCategory.name }}</option>
                      {% endfor %}
                    </select>
                  </div>

                  <span class="errors">{{ expense.errors.category }}</span>

                  <div class="input-group mt-3">
                    <div class="input-group-prepend">
                      <span class="input-group-text" id="basic-addon4"><i
                          class="icon-credit-card inputGroup-sizing-lg"></i></span>
                    </div>
                    <select id="payment" class="payment-method form-control form-control-lg" name="payment"
                      aria-label="payment" aria-describedby="basic-addon4">
                      <option value="" disabled="" selected="" hidden="">-- payment method --
                      </option>

                      {% for paymentMethod in paymentMethods %}
                      <option>{{ paymentMethod.name }}</option>
                      {% endfor %}

                    </select>
                  </div>

                  <span class="errors">{{ expense.errors.payment }}</span>

                  <div class="input-group mt-3">
                    <div class="input-group-prepend">
                      <span class="input-group-text"><i class="icon-comment inputGroup-sizing-lg"></i></span>
                    </div>
                    <textarea id="comment" class="form-control" name="comment" maxlength="100" rows="2"
                      style="resize: none" aria-label="With textarea"></textarea>
                  </div>

                  <span class="errors">{{ expense.errors.comment }}</span>

                  {% for message in flash_messages %}
                  <div class="mt-3 text-center alert alert-{{message.type}}">
                    {{ message.body }}
                  </div>
                  {% endfor %}

                  <input type="hidden" id="expenseId" name="expenseId" class="form-control">
                </div>
                <div class="modal-footer">
                  <div class="row justify-content-center mt-3 mb-0 mb-lg-2">
                    <input id="modal-select" class="add-button btn px-0 py-3 m-2" type="submit" value="Update">
                    <input onclick="window.location.href='#'" id="modal-close"
                      class="cancel-button btn px-0 py-3 btn-secondary m-2" type="button" value="Cancel">
                  </div>

                </div>
              </form>
            </div>
          </div>
        </div>
        <!-- end of modal -->

      </div>
    </div>

    <div class=" line-h row align-items-start justify-content-center">
      <h2 class="header display-5 p-3 mt-1 mt-lg-5">Individual incomes</h2>
    </div>
    <div class="row justify-content-center mx-0 mb-1">
      <div class="col-sm-12 col-lg-10">
        <table class="table table-hover table-sm">
          <thead class="thead-dark">
            <tr class="text-center">
              <th scope="col">Category</th>
              <th scope="col">Amount</th>
              <th scope="col">Date</th>
              <th scope="col">Comment</th>
              <th scope="col" style="width: 5%"></th>
            </tr>
          </thead>
          <tbody>

            {% for individualIncome in individualIncomes %}
            <tr id="{{individualIncome.id}}">
              <td data-target="category" class="pl-3">{{ individualIncome.income_category_name }}</td>
              <td data-target="amount" class="text-center">{{ individualIncome.amount }}</td>
              <td data-target="date" class="text-center">{{ individualIncome.date_of_income }}</td>
              <td data-target="comment" class="comment">{{ individualIncome.income_comment }}</td>
              <td data-role="updateIncome" data-id="{{individualIncome.id}}"><i
                  class="justify-content-center input-group-append bi bi-pencil-square inputGroup-sizing-lg mt-2"></i>
              </td>
            </tr>
            {% endfor %}

          </tbody>
        </table>


      </div>
    </div>
    <div class="line-h row align-items-start justify-content-center">
      <h2 id="balance" class="header balance display-5 p-3 my-2 mb-1"></h2>

      <div id="myChart" class="mx-5" style="height: 450px; width: 100%;"></div>
    </div>
  </div>
</section>




{% endblock %}